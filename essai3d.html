<!DOCTYPE html>
<html lang="fr">

<head>
	<meta charset="utf-8" />
	<title>Labyrinthe</title>
	<script src="proc.js"></script>
	<script src="util.js"></script>
	<script>
		var laby;
		var image;
		var mouvements = 0;
		var largeur = 10;
		var hauteur = 10;
		var tOrientations = [-1, 0, 1, 0, -1];

		function init(largeur, hauteur) {
			mouvements = 0;
			document.onkeypress = touche;
			laby = labyrinthe(largeur, hauteur);
			image = document.getElementById("lab").firstChild;
			image.hauteur = laby.length;
			image.largeur = laby[0].length;
			for (var x = 0; x < image.largeur; x++) {
				if (laby[0][x] & 1) {
					image.colonne = x;
				}
			}
			image.rangee = 0;
			image.direction = 2;
			afficherMur();
			document.getElementById("plat").innerHTML = affichage(laby, 'pierre');
			document.getElementById('mouvements').innerHTML = mouvements;
		}

		function touche(event) {
			//detail(event);
			switch (event.keyCode) {
				case 37: // gauche
					image.direction = (image.direction + 3) % 4;
					if (event.shiftKey && (laby[image.rangee][image.colonne] & Math.pow(2, image.direction))) {
						image.colonne += tOrientations[image.direction + 1];
						image.rangee += tOrientations[image.direction];
						mouvements++;
					}
					break;
				case 39: // droite
					image.direction = (image.direction + 1) % 4;
					if (event.shiftKey && (laby[image.rangee][image.colonne] & Math.pow(2, image.direction))) {
						image.colonne += tOrientations[image.direction + 1];
						image.rangee += tOrientations[image.direction];
						mouvements++;
					}
					break;
				case 38: // haut
					if (laby[image.rangee][image.colonne] & Math.pow(2, image.direction)) {
						image.colonne += tOrientations[image.direction + 1];
						image.rangee += tOrientations[image.direction];
						mouvements++;
					}
					break;
				case 40: // bas
					if (laby[image.rangee][image.colonne] & Math.pow(2, (image.direction + 2) % 4)) {
						image.colonne -= tOrientations[image.direction + 1];
						image.rangee -= tOrientations[image.direction];
						mouvements++;
					}
					break;
				default:
			}
			if (image.rangee == image.hauteur || image.colonne == image.largeur) {
				alert("Bravo! Vous avez parcouru le labyrinthe en " + mouvements + " mouvements.");
				init(largeur, hauteur);
			} else if (image.rangee < 0 || image.colonne < 0) {
				alert("Froussard!!!");
				init(largeur, hauteur);
			} else {
				afficherMur();
			}

			document.getElementById('mouvements').innerHTML = mouvements;
			event.cancelBubble = true;
		}

		function afficherMur() {
			var dir = image.direction;
			dir = (dir + 3) % 4;
			var vue = laby[image.rangee][image.colonne];
			vue = vue >> dir | vue << 4 - dir;
			vue = vue & 7;
			image.src = "laby3d/" + vue + ".gif";
			if (vue & 2) {
				// Le fond niveau 1 est ouvert
				var nlleColonne = image.colonne + tOrientations[image.direction + 1];
				var nlleRangee = image.rangee + tOrientations[image.direction];
				if (nlleRangee >= image.hauteur || nlleColonne >= image.largeur || nlleRangee < 0 || nlleColonne < 0) {
					// La case vue au delà est à l'extérieur du laby
					document.getElementById('centre').src = "laby3d/9.gif";
					document.getElementById('centre2').src = "laby3d/9.gif";
				} else {
					vue = laby[nlleRangee][nlleColonne];
					vue = vue >> dir | vue << 4 - dir;
					vue = vue & 7;
					document.getElementById('centre').src = "laby3d/" + vue + ".gif";
					if (vue & 2) {
						// Le fond niveau 2 est ouvert
						nlleColonne += tOrientations[image.direction + 1];
						nlleRangee += tOrientations[image.direction];
						if (nlleRangee >= image.hauteur || nlleColonne >= image.largeur || nlleRangee < 0 || nlleColonne < 0) {
							document.getElementById('centre2').src = "laby3d/8.gif";
						} else {
							vue = laby[nlleRangee][nlleColonne];
							vue = vue >> dir | vue << 4 - dir;
							vue = vue & 7;
							document.getElementById('centre2').src = "laby3d/" + vue + ".gif";
						}
					} else {
						document.getElementById('centre2').src = "laby3d/8.gif";
					}
				}
			} else {
				document.getElementById('centre').src = "laby3d/8.gif";
				document.getElementById('centre2').src = "laby3d/8.gif";
			}

		}

		function perso() {
			largeur = parseInt(document.getElementById("largeur").value);
			hauteur = parseInt(document.getElementById("hauteur").value);
			if (isNaN(largeur)) largeur = 15;
			if (isNaN(hauteur)) hauteur = 15;
			init(largeur, hauteur);
		}

	</script>
</head>

<body onload="init(10,10)">
	<div>
		<table>
			<tr>
				<td>
					<input type="submit" name="Submit" value="Petit" onclick="init(largeur=7,hauteur=7)" />
					<input type="submit" name="Submit2" value="Moyen" onclick="init(largeur=10,hauteur=10)" />
					<input type="submit" name="Submit3" value="Grand" onclick="init(largeur=15,hauteur=15)" />
					<input type="button" name="taille" value="Personnalis&eacute;" onclick="perso();" /> Largeur
					<input name="largeur" type="text" size="5" id="largeur" /> Hauteur
					<input name="hauteur" type="text" size="5" id="hauteur" />
				</td>
			</tr>
		</table>
	</div>
	<div id="lab"><img src="laby3d/0.gif" width="256" height="256" /><img id="centre" src="laby3d/0.gif" width="256" height="256" style="position:relative
; top: -64px; left: -192px; width: 128px; height: 128px" /><img src="laby3d/0.gif" name="centre2" width="256" height="256" id="centre2" style="position:relative
; top: -96px; left: -288px; width: 64px; height: 64px" /></div>
	<div id="plat"></div>
	<div>Nombre de mouvements : <span id="mouvements" style="color:blue; font-weight:bold;">0</span></div>
	<div id="debug"> </div>
</body>

</html>
